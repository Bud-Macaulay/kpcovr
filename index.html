<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>KPCovR</title>

    <!-- Dependencies -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chemiscope@latest/dist/chemiscope.min.js"></script>

    <style>
      body {
        margin: 1em;
        font-family: "Open Sans", sans-serif;
      }

      h3 {
        color: rgb(21, 101, 192);
        font-size: 22px;
        font-weight: 400;
        padding: 0px;
        margin: 0px;
      }

      .doi-badge {
        font-size: 12px;
      }

      .doi-left {
        background-color: rgb(52, 58, 64);
        color: white;
        font-family: "Roboto", sans-serif;
        border-top-left-radius: 18%;
        border-bottom-left-radius: 18%;
      }

      .doi-right {
        background-color: rgb(192, 219, 255);
        color: black;
        font-family: "Roboto", sans-serif;
        text-decoration: none;
        border-top-right-radius: 3px;
        border-bottom-right-radius: 3px;
        padding-left: 5px;
      }

      /* Hover effects */
      .doi-right:hover {
        background-color: rgb(205, 230, 255); /* slightly lighter blue */
        color: black;
      }

      #accordion-container {
        max-width: 800px;
        margin: 10px auto 50px auto;
      }

      .accordion {
        margin-bottom: 10px;
        border-radius: 3px 3px 3px 3px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-family: "Open Sans", sans-serif;
      }

      .accordion-btn {
        background-color: rgb(21, 101, 192);
        font-family: "Open Sans", sans-serif;
        font-size: 15px;
        font-weight: 500;
        color: #e9e9e9;
        cursor: pointer;
        padding: 6px 18px;
        width: 100%;
        text-align: left;
        border: none;
        outline: none;
        transition: 0.2s;
        position: relative; /* allows pseudo-element positioning */
      }

      /* Chevron icon on the right */
      .accordion-btn::after {
        content: "›"; /* Unicode right arrow */
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%) rotate(0deg);
        transition: transform 0.2s ease;
        font-size: 24px;
      }

      /* Rotate chevron when active (downward arrow) */
      .accordion-btn.active::after {
        transform: translateY(-50%) rotate(90deg);
        color: black; /* match active state color */
      }

      .accordion-btn.active {
        background-color: #ccc;
        color: black;
      }

      .accordion-panel {
        padding: 0 10px;
        display: none;
        overflow: hidden;
        background-color: #f9f9f9;
        border-left: 1px solid #ccc;
        border-right: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
      }

      .accordion-panel p {
        margin: 10px 8px;
      }

      .accordion-panel a {
        color: rgb(62, 112, 187);
        text-decoration: none; /* no underline by default */
        transition: color 0.2s, text-decoration 0.2s;
      }

      .accordion-panel a:hover {
        color: rgb(30, 80, 160);
        text-decoration: underline;
      }

      #kpcovrWrapper {
        margin: 1em;
      }
      #tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
        margin-bottom: 1em;
      }
      button.tab {
        background: #eee;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 0.4em 0.8em;
        cursor: pointer;
        transition: background 0.2s;
      }
      button.tab.active {
        background: #0077cc;
        color: white;
      }

      button.tab.active:hover {
        background: #0077cc;
        color: white;
        cursor: default;
      }

      button.tab:hover {
        background: #ddd;
      }

      #top-container,
      #bottom-container {
        display: flex;
        justify-content: center;
      }
      #viewer-container {
        display: flex;
        gap: 1em;
        justify-content: center;
        flex-wrap: wrap;
        padding: 1em;
      }

      /* Left column (map) */
      #map {
        flex: 1 1 500px;
        min-width: 500px;
        height: 600px;
        max-width: 1250px;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 1px;
      }

      /* Right column (structure + info stacked vertically) */
      #rhs-container {
        display: flex;
        flex-direction: column;
        flex: 1 1 500px; /* grow/shrink, min-width 500px */
        min-width: 500px;
        max-width: 1250px;
        gap: 1em;
      }

      /* Structure takes most of RHS height */
      #structure {
        flex: 1;
        height: 600px;
        min-height: 400px;
        border-radius: 8px;
      }

      /* Info box below structure */
      #info {
        flex: 0 0 auto;
        padding: 0.5em 0.5em;
        border-radius: 6px;
        background-color: #f5f5f5;
      }

      .error {
        color: red;
        margin: 1em;
      }

      @media (max-width: 1100px) {
        #map,
        #rhs-container {
          flex: 1 1 100%; /* full width on smaller screens */
          min-width: 0;
        }
      }
    </style>
  </head>

  <body>
    <!-- Materials Cloud header (optional) -->
    <script
      src="https://cdn.jsdelivr.net/gh/materialscloud-org/mc-header@main/header.js"
      defer
    ></script>

    <script>
      var breadcrumbsPath = [
        { name: "Discover", link: "https://www.materialscloud.org/discover" },
        {
          name: "KPCovR",
          link: null,
        },
      ];
    </script>

    <div id="kpcovrWrapper">
      <div
        style="
          padding: 3px;
          border-bottom: 1px;
          border-color: #888;
          border-bottom-style: solid;
        "
      >
        <h3>Kernel principal covariates regression</h3>

        <span class="doi-badge">
          <span class="doi-left">DOI</span
          ><a
            href="https://doi.org/10.24435/materialscloud:ay-eq"
            class="doi-right"
            >10.24435/materialscloud:ay-eq</a
          >
        </span>
      </div>

      <!-- Narrow accordions -->
      <div id="accordion-container">
        <div class="accordion">
          <button class="accordion-btn">About</button>
          <div class="accordion-panel">
            <p>
              These datasets contain low-dimensional representations of the
              structures, or the atom-centered environments within them, using a
              dimensionality reduction algorithm called KPCovR (Kernel Principal
              Covariates Regression), that aims at obtaining a low-dimensional
              representation that reproduces a large fraction of the intrinsic
              structural variability of the structures, and correlates linearly
              with the properties associated with them. The emphasis that is
              given to the variance maximization or the property regression task
              is controlled by a parameter α, with α=0 indicating complete focus
              on regression, and α=1 being equivalent to principal component
              analysis.
            </p>
            <p>
              Maps are visualized using chemiscope, an interactive
              structure/property explorer for materials and molecules.
            </p>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-btn">How to cite</button>
          <div class="accordion-panel">
            <div>
              <ul>
                <li>
                  <em
                    >Structure-Property Maps with Kernel Principal Covariates
                    Regression</em
                  ><br />
                  B. A. Helfrecht, R. K. Cersonsky, G. Fraux, and M. Ceriotti,
                  <a href="https://arxiv.org/abs/2002.05076"
                    >arXiv:2002.05076 (2020)</a
                  >
                </li>
                <br />
                <li>
                  <em
                    >Chemiscope: interactive structure-property explorer for
                    materials and molecules</em
                  ><br />
                  G. Fraux, R. K. Cersonsky, and M. Ceriotti.
                  <a href="https://doi.org/10.21105/joss.02117"
                    >Journal of Open Source Software, 5(51), 2117, (2020)</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-btn">Acknowledgements</button>
          <div class="accordion-panel">
            <p class="">
              This work has been supported by the
              <a href="https://nccr-marvel.ch/">NCCR MARVEL</a>, the European
              Centre of Excellence <a href="http://www.max-centre.eu/">MaX</a>,
              the ERC Starting Grant
              <a href="https://www.epfl.ch/labs/cosmo/research/hbmap/">HBMAP</a
              >, the <a href="http://www.sccer-eip.ch/">SCCER EIP</a> project
              and the <a href="http://www.snf.ch/">SNSF</a> project n.
              200021-182057.
            </p>
          </div>
        </div>
      </div>

      <!-- Dataset selection tabs -->
      <div id="tabs"></div>
      <div id="error" class="error"></div>

      <!-- Chemiscope viewer panels -->
      <!-- Center meta/info in a parent container -->
      <div id="top-container">
        <div id="meta"></div>
      </div>

      <!-- Map and structure side by side -->
      <div id="viewer-container">
        <div id="map"></div>
        <div id="rhs-container">
          <div id="structure"></div>
          <div id="info"></div>
        </div>
      </div>

      <span style="font-size: x-small; float: right">
        powered by <a href="https://chemiscope.org">chemiscope</a>
      </span>

      <script type="text/javascript">
        // Define datasets manually (from ./datafiles)
        const datasets = {
          "Arginine dipeptide":
            "datafiles/arginine-kpcovr-0.55-chemiscope.json",
          "Azaphenacenes 0.65":
            "datafiles/azaphenacenes-kpcovr-0.65-chemiscope.json",
          "Carbon α=0.0": "datafiles/C-VII-kpcovr-0.0-chemiscope.json",
          "Carbon α=0.5": "datafiles/C-VII-kpcovr-0.5-chemiscope.json",
          "Carbon α=1.0": "datafiles/C-VII-kpcovr-1.0-chemiscope.json",
          "DEEM Zeolites (local properties)":
            "datafiles/DEEM-local-kpcovr-0.5-chemiscope.json",
          "DEEM Zeolites (global properties)":
            "datafiles/DEEM-global-kpcovr-0.5-chemiscope.json",
          "QM9 α=0.0": "datafiles/qm9-12PC-kpcovr-0.5-chemiscope.json",
          "QM9 α=0.5": "datafiles/qm9-12PC-kpcovr-1.0-chemiscope.json",
        };

        const config = {
          map: "map",
          meta: "meta",
          info: "info",
          structure: "structure",
        };

        // Build tab buttons dynamically
        const tabsContainer = document.getElementById("tabs");
        for (const [name, path] of Object.entries(datasets)) {
          const btn = document.createElement("button");
          btn.className = "tab";
          btn.textContent = name;
          btn.onclick = () => loadDataset(name, path, btn);
          tabsContainer.appendChild(btn);
        }

        function parseJsonWithNaN(text) {
          return JSON.parse(
            text.replace(/\bNaN\b/g, '"***NaN***"'),
            (key, value) => {
              return value === "***NaN***" ? NaN : value;
            }
          );
        }

        function loadDataset(name, path, button) {
          // Clear previous Chemiscope content
          document.getElementById("meta").innerHTML = "";
          document.getElementById("map").innerHTML = "";
          document.getElementById("structure").innerHTML = "";
          document.getElementById("info").innerHTML = "";
          const errorDiv = document.getElementById("error");
          errorDiv.textContent = "Loading " + name + "...";

          // Deactivate all buttons
          document
            .querySelectorAll("button.tab")
            .forEach((b) => b.classList.remove("active"));
          button.classList.add("active");

          // Fetch the dataset JSON with NaN handling
          fetch(path)
            .then((response) => {
              if (!response.ok) throw new Error(`HTTP ${response.status}`);
              return response.text(); // read as text
            })
            .then((text) => parseJsonWithNaN(text)) // parse with NaN fix
            .then((dataset) => {
              errorDiv.textContent = "";
              Chemiscope.DefaultVisualizer.load(config, dataset);
            })
            .catch((err) => {
              errorDiv.innerHTML = `<div>Failed to load ${name}: ${err}</div>`;
            });
        }

        // accordion buttons
        document.querySelectorAll(".accordion-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            btn.classList.toggle("active");
            const panel = btn.nextElementSibling;
            if (panel.style.display === "block") {
              panel.style.display = "none";
            } else {
              panel.style.display = "block";
            }
          });
        });

        // Auto-load the first dataset on page load
        document.addEventListener("DOMContentLoaded", () => {
          const firstTab = document.querySelector("button.tab");
          if (firstTab) firstTab.click();
        });
      </script>
    </div>
  </body>
</html>
