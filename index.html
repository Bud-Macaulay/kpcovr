<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="mcloud_logo.png" />
    <title>KPCovR</title>

    <!-- Dependencies -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chemiscope@latest/dist/chemiscope.min.js"></script>

    <style>
      body {
        margin: 1em;
        font-family: "Open Sans", sans-serif;
      }

      h3 {
        color: rgb(21, 101, 192);
        font-size: 22px;
        font-weight: 400;
        margin: 0;
        padding: 0;
      }

      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 3px 0;
        border-bottom: 1px solid #d7dfe2;
      }

      .title-doi {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .header-image img {
        height: 80px;
        width: auto;
        object-fit: contain;
      }

      .doi-badge {
        color: #333;
        font-size: 75%;
        margin-bottom: 9px;
        margin-top: 0;
        font-weight: 400;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
      }

      .doi-left {
        border-radius: 0.25rem;
        border-top-right-radius: 0.25rem;
        border-bottom-right-radius: 0.25rem;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        color: #fff;
        background-color: #343a40;
        display: inline-block;
        padding: 0.25em 0.4em;
        display: inline-block;
      }

      .doi-right {
        border-radius: 0.25rem;
        border-top-left-radius: 0.25rem;
        border-bottom-left-radius: 0.25rem;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        color: #212529;
        background-color: #a2cbff;
        display: inline-block;
        padding: 0.25em 0.4em;
        text-decoration: none;
      }

      .doi-right:hover {
        background-color: rgb(205, 230, 255);
      }

      #accordion-container {
        max-width: 800px;
        margin: 1em auto 2em;
      }

      .accordion {
        margin-bottom: 6px;
        border-radius: 3px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-family: "Open Sans", sans-serif;
      }

      .accordion-btn {
        background-color: rgb(21, 101, 192);
        color: #e9e9e9;
        font-size: 15px;
        font-weight: 500;
        width: 100%;
        padding: 6px 14px;
        text-align: left;
        border: none;
        cursor: pointer;
        outline: none;
        position: relative;
        transition: background-color 0.2s;
        letter-spacing: 1px;
        word-spacing: 2.5px;
      }

      .accordion-btn::after {
        content: "›";
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 24px;
        transition: transform 0.2s ease;
      }

      .accordion-btn.active {
        background-color: #ccc;
        color: #000;
      }

      .accordion-btn.active::after {
        transform: translateY(-50%) rotate(90deg);
        color: #000;
      }

      .accordion-panel {
        display: none;
        overflow: hidden;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        border-top: none;
        padding: 0 10px;
      }

      .accordion-panel p {
        margin: 10px 8px;
      }

      .accordion-panel a {
        color: rgb(62, 112, 187);
        text-decoration: none;
        transition: color 0.2s, text-decoration 0.2s;
      }

      .accordion-panel a:hover {
        color: rgb(30, 80, 160);
        text-decoration: underline;
      }

      #kpcovrWrapper {
        margin: 1em;
      }

      #tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
        margin-bottom: 1em;
      }

      button.tab {
        background: #eee;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 0.4em 0.8em;
        cursor: pointer;
        transition: background 0.2s;
      }

      button.tab:hover {
        background: #ddd;
      }

      button.tab.active {
        background: #0077cc;
        color: #fff;
        cursor: default;
        pointer-events: none;
      }

      #top-container,
      #bottom-container {
        display: flex;
        justify-content: center;
      }

      #viewer-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1em;
        padding: 1em;
      }

      #map {
        flex: 1 1 500px;
        min-width: 500px;
        max-width: 1250px;
        height: 600px;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 1px;
      }

      #rhs-container {
        display: flex;
        flex-direction: column;
        flex: 1 1 500px;
        min-width: 500px;
        max-width: 1250px;
        gap: 1em;
      }

      #structure {
        flex: 1;
        height: 600px;
        min-height: 400px;
        border-radius: 8px;
      }

      #info {
        padding: 0.5em;
        border-radius: 6px;
        background-color: #f5f5f5;
      }

      .error {
        color: red;
        margin: 1em;
      }

      /* media query stack under the other. */
      @media (max-width: 1100px) {
        #map,
        #rhs-container {
          flex: 1 1 100%;
          min-width: 0;
        }
      }
    </style>
  </head>

  <body>
    <script
      src="https://cdn.jsdelivr.net/gh/materialscloud-org/mc-header@main/header.js"
      defer
    ></script>

    <script>
      var breadcrumbsPath = [
        { name: "Discover", link: "https://www.materialscloud.org/discover" },
        {
          name: "KPCovR",
          link: null,
        },
      ];
    </script>

    <div id="kpcovrWrapper">
      <div class="header-container">
        <div class="title-doi">
          <h3>Kernel principal covariates regression</h3>
          <span class="doi-badge">
            <span class="doi-left">DOI</span
            ><a
              href="https://doi.org/10.24435/materialscloud:ay-eq"
              class="doi-right"
              >10.24435/materialscloud:ay-eq</a
            >
          </span>
        </div>
        <div class="header-image">
          <img src="kpcovr_image.png" alt="KPCovR" />
        </div>
      </div>

      <!-- Narrow accordions -->
      <div id="accordion-container">
        <div class="accordion">
          <button class="accordion-btn">About</button>
          <div class="accordion-panel">
            <p>
              These datasets contain low-dimensional representations of the
              structures, or the atom-centered environments within them, using a
              dimensionality reduction algorithm called KPCovR (Kernel Principal
              Covariates Regression), that aims at obtaining a low-dimensional
              representation that reproduces a large fraction of the intrinsic
              structural variability of the structures, and correlates linearly
              with the properties associated with them. The emphasis that is
              given to the variance maximization or the property regression task
              is controlled by a parameter α, with α=0 indicating complete focus
              on regression, and α=1 being equivalent to principal component
              analysis.
            </p>
            <p>
              Maps are visualized using chemiscope, an interactive
              structure/property explorer for materials and molecules.
            </p>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-btn">How to cite</button>
          <div class="accordion-panel">
            <div>
              <ul>
                <li>
                  <em
                    >Structure-Property Maps with Kernel Principal Covariates
                    Regression</em
                  ><br />
                  B. A. Helfrecht, R. K. Cersonsky, G. Fraux, and M. Ceriotti,
                  <a href="https://arxiv.org/abs/2002.05076"
                    >arXiv:2002.05076 (2020)</a
                  >
                </li>
                <br />
                <li>
                  <em
                    >Chemiscope: interactive structure-property explorer for
                    materials and molecules</em
                  ><br />
                  G. Fraux, R. K. Cersonsky, and M. Ceriotti.
                  <a href="https://doi.org/10.21105/joss.02117"
                    >Journal of Open Source Software, 5(51), 2117, (2020)</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-btn">Acknowledgements</button>
          <div class="accordion-panel">
            <p class="">
              This work has been supported by the
              <a href="https://nccr-marvel.ch/">NCCR MARVEL</a>, the European
              Centre of Excellence <a href="http://www.max-centre.eu/">MaX</a>,
              the ERC Starting Grant
              <a href="https://www.epfl.ch/labs/cosmo/research/hbmap/">HBMAP</a
              >, the <a href="http://www.sccer-eip.ch/">SCCER EIP</a> project
              and the <a href="http://www.snf.ch/">SNSF</a> project n.
              200021-182057.
            </p>
          </div>
        </div>
      </div>

      <!-- Dataset selection tabs -->
      <div id="tabs"></div>
      <div id="error" class="error"></div>

      <!-- Chemiscope viewer panels -->
      <!-- Center meta/info in a parent container -->
      <div id="top-container">
        <div id="meta"></div>
      </div>

      <!-- Map and structure side by side -->
      <div id="viewer-container">
        <div id="map"></div>
        <div id="rhs-container">
          <div id="structure"></div>
          <div id="info"></div>
        </div>
      </div>

      <span style="font-size: x-small; float: right">
        powered by <a href="https://chemiscope.org">chemiscope</a>
      </span>

      <script type="text/javascript">
        const datasets = {
          arginine: {
            label: "Arginine dipeptide",
            path: "datafiles/arginine-kpcovr-0.55-chemiscope.json",
          },
          azaphenacenes: {
            label: "Azaphenacenes",
            path: "datafiles/azaphenacenes-kpcovr-0.65-chemiscope.json",
          },
          "carbons-00": {
            label: "Carbon α=0.0",
            path: "datafiles/C-VII-kpcovr-0.0-chemiscope.json",
          },
          "carbons-05": {
            label: "Carbon α=0.5",
            path: "datafiles/C-VII-kpcovr-0.5-chemiscope.json",
          },
          "carbons-10": {
            label: "Carbon α=1.0",
            path: "datafiles/C-VII-kpcovr-1.0-chemiscope.json",
          },
          csd: {
            label: "Chemical Shieldings",
            path: "datafiles/CSD-1000R-kpcovr-0.5-chemiscope.json",
          },
          "deem-local": {
            label: "DEEM Zeolites (local properties)",
            path: "datafiles/DEEM-local-kpcovr-0.5-chemiscope.json",
          },
          "deem-global": {
            label: "DEEM Zeolites (global properties)",
            path: "datafiles/DEEM-global-kpcovr-0.5-chemiscope.json",
          },
          "qm9-05": {
            label: "QM9 α=0.5",
            path: "datafiles/qm9-12PC-kpcovr-0.5-chemiscope.json",
          },
          "qm9-10": {
            label: "QM9 α=1.0",
            path: "datafiles/qm9-12PC-kpcovr-1.0-chemiscope.json",
          },
        };

        const config = {
          map: "map",
          meta: "meta",
          info: "info",
          structure: "structure",
        };

        // Build tab buttons dynamically
        const tabsContainer = document.getElementById("tabs");

        for (const [slug, { label, path }] of Object.entries(datasets)) {
          const btn = document.createElement("button");
          btn.className = "tab";
          btn.textContent = label;
          btn.dataset.slug = slug;
          btn.onclick = () => loadDataset(label, path, btn);
          tabsContainer.appendChild(btn);
        }

        // fix NaN in JSONS.
        function parseJsonWithNaN(text) {
          return JSON.parse(
            text.replace(/\bNaN\b/g, '"***NaN***"'),
            (key, value) => {
              return value === "***NaN***" ? NaN : value;
            }
          );
        }

        function loadDataset(name, path, button) {
          // Clear previous Chemiscope content
          document.getElementById("meta").innerHTML = "";
          document.getElementById("map").innerHTML = "";
          document.getElementById("structure").innerHTML = "";
          document.getElementById("info").innerHTML = "";
          const errorDiv = document.getElementById("error");
          errorDiv.textContent = "Loading " + name + "...";

          // Deactivate all buttons
          document
            .querySelectorAll("button.tab")
            .forEach((b) => b.classList.remove("active"));
          button.classList.add("active");

          // Fetch the dataset JSON with NaN handling
          fetch(path)
            .then((response) => {
              if (!response.ok) throw new Error(`HTTP ${response.status}`);
              return response.text(); // read as text
            })
            .then((text) => parseJsonWithNaN(text)) // parse with NaN fix
            .then((dataset) => {
              errorDiv.textContent = "";
              Chemiscope.DefaultVisualizer.load(config, dataset);
            })
            .catch((err) => {
              errorDiv.innerHTML = `<div>Failed to load ${name}: ${err}</div>`;
            });
          history.replaceState(null, "", `#${button.dataset.slug}`);
        }

        // accordion buttons
        document.querySelectorAll(".accordion-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            btn.classList.toggle("active");
            const panel = btn.nextElementSibling;
            if (panel.style.display === "block") {
              panel.style.display = "none";
            } else {
              panel.style.display = "block";
            }
          });
        });

        // Auto-load the first dataset on page load
        document.addEventListener("DOMContentLoaded", () => {
          const tabs = document.querySelectorAll("button.tab");

          // Get query param and hash
          const urlParams = new URLSearchParams(window.location.search);
          const datasetParam = urlParams.get("dataset");
          const hash = window.location.hash.slice(1);

          // Decide which slug to use (query param preferred)
          const slugToUse = datasetParam || hash;

          // Update URL: replace ?dataset=... with #slug
          if (datasetParam) {
            history.replaceState(
              null,
              "",
              `${window.location.pathname}#${slugToUse}`
            );
          }

          // Find and click the corresponding tab
          const tabToClick =
            [...tabs].find((tab) => tab.dataset.slug === slugToUse) || tabs[0];

          if (tabToClick) tabToClick.click();
        });
      </script>
    </div>
  </body>
</html>
