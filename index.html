<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chemiscope Multi-Dataset Viewer</title>

    <!-- Dependencies -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chemiscope@latest/dist/chemiscope.min.js"></script>

    <style>
      body {
        font-family: sans-serif;
        margin: 1em;
      }
      #kpcovrWrapper {
        margin: 1em;
      }
      #tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
        margin-bottom: 1em;
      }
      button.tab {
        background: #eee;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 0.4em 0.8em;
        cursor: pointer;
        transition: background 0.2s;
      }
      button.tab.active {
        background: #0077cc;
        color: white;
      }
      /* Center meta and info horizontally */
      #top-container,
      #bottom-container {
        display: flex;
        justify-content: center; /* centers child horizontally */
      }
      #viewer-container {
        display: flex;
        gap: 1em;
        justify-content: center;
        flex-wrap: wrap; /* allows RHS to move under map */
        padding: 1em;
      }

      /* Left column (map) */
      #map {
        flex: 1 1 500px; /* grow/shrink, min-width 500px */
        min-width: 500px;
        height: 600px;
        max-width: 1250px;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 1px;
      }

      /* Right column (structure + info stacked vertically) */
      #rhs-container {
        display: flex;
        flex-direction: column;
        flex: 1 1 500px; /* grow/shrink, min-width 500px */
        min-width: 500px;
        max-width: 1250px;
        gap: 1em;
      }

      /* Structure takes most of RHS height */
      #structure {
        flex: 1;
        height: 600px;
        min-height: 400px;
        border-radius: 8px;
      }

      /* Info box below structure */
      #info {
        flex: 0 0 auto;
        padding: 0.5em 0.5em;
        border-radius: 6px;
        background-color: #f5f5f5;
      }

      .error {
        color: red;
        margin: 1em;
      }

      @media (max-width: 1100px) {
        #map,
        #rhs-container {
          flex: 1 1 100%; /* full width on smaller screens */
          min-width: 0;
        }
      }
    </style>
  </head>

  <body>
    <!-- Materials Cloud header (optional) -->
    <script
      src="https://cdn.jsdelivr.net/gh/materialscloud-org/mc-header@main/header.js"
      defer
    ></script>

    <script>
      var breadcrumbsPath = [
        { name: "Discover", link: "https://www.materialscloud.org/discover" },
        {
          name: "KPCovR",
          link: null,
        },
      ];
    </script>

    <div id="kpcovrWrapper">
      <h2>Chemiscope Multi-Dataset Viewer</h2>

      <!-- Dataset selection tabs -->
      <div id="tabs"></div>
      <div id="error" class="error"></div>

      <!-- Chemiscope viewer panels -->
      <!-- Center meta/info in a parent container -->
      <div id="top-container">
        <div id="meta"></div>
      </div>

      <!-- Map and structure side by side -->
      <div id="viewer-container">
        <div id="map"></div>
        <div id="rhs-container">
          <div id="structure"></div>
          <div id="info"></div>
        </div>
      </div>

      <span style="font-size: x-small; float: right">
        powered by <a href="https://chemiscope.org">chemiscope</a>
      </span>

      <script type="text/javascript">
        // Define datasets manually (from ./datafiles)
        const datasets = {
          "Arginine dipeptide":
            "datafiles/arginine-kpcovr-0.55-chemiscope.json",
          "Azaphenacenes 0.65":
            "datafiles/azaphenacenes-kpcovr-0.65-chemiscope.json",
          "Carbon α=0.0": "datafiles/C-VII-kpcovr-0.0-chemiscope.json",
          "Carbon α=0.5": "datafiles/C-VII-kpcovr-0.5-chemiscope.json",
          "Carbon α=1.0": "datafiles/C-VII-kpcovr-1.0-chemiscope.json",
          "DEEM Zeolites (local properties)":
            "datafiles/DEEM-local-kpcovr-0.5-chemiscope.json",
          "DEEM Zeolites (global properties)":
            "datafiles/DEEM-global-kpcovr-0.5-chemiscope.json",
          "QM9 α=0.0": "datafiles/qm9-12PC-kpcovr-0.5-chemiscope.json",
          "QM9 α=0.5": "datafiles/qm9-12PC-kpcovr-1.0-chemiscope.json",
        };

        const config = {
          map: "map",
          meta: "meta",
          info: "info",
          structure: "structure",
        };

        // Build tab buttons dynamically
        const tabsContainer = document.getElementById("tabs");
        for (const [name, path] of Object.entries(datasets)) {
          const btn = document.createElement("button");
          btn.className = "tab";
          btn.textContent = name;
          btn.onclick = () => loadDataset(name, path, btn);
          tabsContainer.appendChild(btn);
        }

        function parseJsonWithNaN(text) {
          return JSON.parse(
            text.replace(/\bNaN\b/g, '"***NaN***"'),
            (key, value) => {
              return value === "***NaN***" ? NaN : value;
            }
          );
        }

        function loadDataset(name, path, button) {
          // Clear previous Chemiscope content
          document.getElementById("meta").innerHTML = "";
          document.getElementById("map").innerHTML = "";
          document.getElementById("structure").innerHTML = "";
          document.getElementById("info").innerHTML = "";
          const errorDiv = document.getElementById("error");
          errorDiv.textContent = "Loading " + name + "...";

          // Deactivate all buttons
          document
            .querySelectorAll("button.tab")
            .forEach((b) => b.classList.remove("active"));
          button.classList.add("active");

          // Fetch the dataset JSON with NaN handling
          fetch(path)
            .then((response) => {
              if (!response.ok) throw new Error(`HTTP ${response.status}`);
              return response.text(); // read as text
            })
            .then((text) => parseJsonWithNaN(text)) // parse with NaN fix
            .then((dataset) => {
              errorDiv.textContent = "";
              Chemiscope.DefaultVisualizer.load(config, dataset);
            })
            .catch((err) => {
              errorDiv.innerHTML = `<div>Failed to load ${name}: ${err}</div>`;
            });
        }

        // Auto-load the first dataset on page load
        document.addEventListener("DOMContentLoaded", () => {
          const firstTab = document.querySelector("button.tab");
          if (firstTab) firstTab.click();
        });
      </script>
    </div>
  </body>
</html>
